<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustainability Presentation</title>
    <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src='templates/slidetemplates.js'></script>
    <script src='templates/slidepartials.js'></script>
    <link rel='stylesheet' href='css/basics.css'>
    <link rel='stylesheet' href='css/presentation.css'>
</head>

<body>
<!--    <h1>Presenation</h1>-->
<!--    <p>This is the presentation screen</p>-->
    <div id='login'>
        <div class='closer'>x</div>
        <p>Please enter the admin password:</p>
        <input type="password" id="passwordInput">

        <button id="submitPassword">Submit</button>
    </div>
    <div id='controls'></div>
    <div id='content'></div>


    <script>
        const socket = io();
        let STOREID = null;
        let gamedata = null;
        let slideList = null;
        let currentSlide = null;
        let clientData = {role: 'presentation'};
        let presentationData = null;
        let storeOb = {
            currentSlide: null
        };
        let session = null
        let scoreMap = [];
        const storeInfo = () => {
            storeOb.currentSlide = currentSlide.index;
            localStorage.setItem(STOREID, JSON.stringify(storeOb));
        };
        const getInfo = () => {
            return JSON.parse(localStorage.getItem(STOREID));
        };
        const prepSlide = (s) => {
            s.url = window.location.origin;
            gamedata.mainTeams.forEach((v, i) => {
                s[`card_${i}`] = v;
            });
//            console.log('prepSlide');
//            console.log(s);
//            console.log(gamedata);
            socket.emit('getSession', (o) => {
//                console.log(o);
            });
            return s;
        };
        const showSlide = (id) => {
            currentSlide = prepSlide(slideList[id]);
//            currentSlide.url = window.location.origin;
            renderSlide(currentSlide.id, currentSlide);
            console.log(currentSlide)
            storeInfo();
        };
        const refreshSlide = () => {
            let i = currentSlide.index;
            currentSlide = prepSlide(presentationData.slideList[i]);
            clearContent();
            renderSlide(currentSlide.id, currentSlide);
        };
        const previousSlide = () => {
            let i = currentSlide.index;
            if (i > 0) {
                showSlide(i - 1);
            }
        };
        const nextSlide = () => {
            let i = currentSlide.index;
            if (i + 1 < slideList.length) {
                showSlide(i + 1);
            }
        };
        const repeater = () => {
            showSlide(0);
            window.location.reload();
            setTimeout(repeater, 1000);
        };

        const setupIntro = () => {
            $('#intro_admin').off('click');
            $('#intro_player').off('click');
            $('#submitPassword').off('click');
            $('#login').find('.closer').off('click');
            $('#login').find('.closer').on('click', () => {
                $('#passwordInput').val('');
                $('#login').hide();
            });
            $('#login').hide();
//            $('')
            $('#intro_admin').on('click', function () {
                $('#login').show();
            });
            $('#submitPassword').on('click', function () {
                let pw = $('#passwordInput').val();
                if (pw !== undefined && pw !== null && pw !== '' ) {
                    socket.emit('adminLogin', pw, (boo) => {
                        if (boo) {
                            $('#login').hide();
                            window.open('admin', '_blank');
                        } else {
                            alert('incorrect password, please try again')
                        }
                    });
                }

            });
            $('#intro_player').on('click', function () {
                window.open('player', '_self');
            });
        };
        const setupCards = () => {
//            $('.flower').hide();
//            console.log('mooooo');
            let i = $(`.stakeholder_card`).length;
            while (i >= 0) {
                showLeaf(i, false, false);
                i--;
            }
            socket.emit('getSession', (s) => {
                console.log('I have the sesh');
                onSessionUpdate(s);
            });
        };
        const showLeaf = (id, boo, anim) => {
            let leaf = $(`#stakeholder_card_${id}`).find('.cls-8');
//            console.log(leaf);
            if (boo) {
                if (anim) {
                    leaf.fadeIn();
                } else {
                    leaf.show();
                }
            } else {
                if (anim) {
                    leaf.fadeOut();
                } else {
                    leaf.hide();
                }
            }
            leaf = $(`#stakeholder_card_${id}`).find('.cls-9');
            if (boo) {
                if (anim) {
                    leaf.fadeIn();
                } else {
                    leaf.show();
                }
            } else {
                if (anim) {
                    leaf.fadeOut();
                } else {
                    leaf.hide();
                }
            }
        };
        const updateCard1 = (c, p, v) => {
            let card = $(`#stakeholder_card_${c}`);
            let prop = card.find(`.${p}`);
            prop.html(v);
//            console.log(c, p, v);
            if (p === 'vote') {
//                console.log('resauce');
                showLeaf(c, true, true);
            }
        };
        const onSessionUpdate = (s) => {
//            console.log('session updated:');
//            console.log(s);
            if (s) {
                session = s;
                updateSlide();
                if (s.scores) {
                    let r = s.scores.round_1;
                    if (r) {
                        r.forEach((v) => {
                            updateCard1(v.targ, v.valID, v.val);
                        });
                    }
                }
            }
        };
        const updateCards = () => {
            let ref = {type: {1: 'st', 2: 'pv'}};
            // adjust the team ID for PV teams (these have IDs of 5 & 6 but for rendering purposes use 1 and 2)
            let type2Adj = gamedata.mainTeams.length;
            socket.emit('getTeams', (r) => {
                r.forEach((t) => {
                    let es = t.scores.eras[`era${session.era}`];
                    let str = '';
                    let d = '';
                    let card = null;
                    let totals = {st: 0, pv: 0, score: 0}
                    if (es) {
                        console.log(`we have ${es.length} scores for ${t.title} (${t.id}):`);
                        card = $(`#stakeholder_card_${t.id}`);
                        let temp = 'TYPEBLANKDEST_vSRC';
                        es.forEach((sc) => {
                            let tempRes = temp.replace('DEST', t.id);
                            let s = sc.split('_');
                            let o = {};
                            let outStr = 'score from ';
                            let outo = {
                                dest: null,
                                val: null,
                                type: null,
                                src: null
                            };
                            Object.values(scoreMap).forEach((v, id) => {
                                if (id > 0 && Boolean(v)) {
                                    s[id] = parseInt(s[id]);
                                    if (v === 'val') {
                                        outo.val = s[id];
                                    }
                                    if (ref.hasOwnProperty(v)) {
                                        if (v === 'type') {
                                            tempRes = tempRes.replace('TYPE', ref[v][s[id]]);
                                            outo.type = ref[v][s[id]];
                                        }
                                    } else if (v === 'id') {
                                        let src = parseInt(s[id]);
                                        outo.src = src;
                                        outo.srcName = gamedata.teams[`t${src}`].title;
                                        if (outo.type === ref.type[2]) {
                                            src = src - gamedata.mainTeams.length;
                                        }
                                        tempRes = tempRes.replace('SRC', (src + 1));
                                    }
                                }
                            });
                            tempRes = tempRes.replace('BLANK', '');
                            outo.dest = tempRes;
                            console.log(outo);
                            totals[outo.type] += outo.val;

//                            Object.entries(totals).forEach((v, id) => {
//                                console.log(id, v);
//                            });
                            if ($(`#${outo.dest}`).find('.scoreboxval').length > 0) {
                                $(`#${outo.dest}`).find('.scoreboxval').html(outo.val);
                            }
                            if ($(`#${outo.dest}`).find('.scoreboxsrc').length > 0) {
                                $(`#${outo.dest}`).find('.scoreboxsrc').html(`${outo.srcName}: `);
                            }
                        });
//                        console.log(totals);
                        totals.score = totals.st * totals.pv;
                        Object.entries(totals).forEach((v) => {
                            let c = $(`#${v[0]}${t.id}_vtotal`);
                            if (c.length) {
                                c.find('.scoreboxval').html(v[1]);
                                c.find('.scoreboxsrc').html(`${v[0]} total: `);
                            }
                        });
                        let c = $(`#score${t.id}`);
                        if (c.length) {
                            c.find('.scoreboxval').html(totals.score);
                            c.find('.scoreboxsrc').html(`score: `);
                        }
                    }
                });
            })
                $('.stakeholder_card').each((c) => {
//                    console.log(c);
                });
        };
        const updateCardsV1 = () => {
            console.log('ashdk');
            let ref = {type: {1: 'st', 2: 'pv'}};
            // adjust the team ID for PV teams (these have IDs of 5 & 6 but for rendering purposes use 1 and 2)
            let type2Adj = gamedata.mainTeams.length;
            socket.emit('getTeams', (r) => {
                r.forEach((t) => {
                    let es = t.scores.eras[`era${session.era}`];
                    let str = '';
                    let d = '';
                    let card = null;
                    if (es) {
                        console.log(`we have ${es.length} scores for ${t.title} (${t.id}):`);
                        card = $(`#stakeholder_card_${t.id}`);
                        let temp = 'TYPEBLANKDEST_vSRC';

                        es.forEach((sc) => {
                            let tempRes = temp.replace('DEST', t.id);
                            let s = sc.split('_');
                            let o = {};
                            let outStr = 'score from ';
                            let outo = {dest: null, val: null};
                            Object.values(scoreMap).forEach((v, id) => {
//                                console.log(`##########################################################`);
                                if (id > 0 && Boolean(v)) {
//                                    str = `${v}`;
//                                    console.log(`v is ${v}`)
                                    if (v === 'val') {
                                        outo.val = s[id];
                                    }
                                    if (ref.hasOwnProperty(v)) {
//                                        str += ` (${ref[v][s[id]]})`;
//                                        console.log('sort out the type');
//                                        console.log(s);
//                                        console.log(ref[v]);

                                        if (v === 'type') {
//                                            console.log(`it is type time: ${ref[v][s[id]]}`);
                                            tempRes = tempRes.replace('TYPE', ref[v][s[id]]);
//                                            tempRes = tempRes.replace('TYPE', 'ref[v][s[id]]');
                                        }
//
                                    } else if (v === 'id') {
//                                        str += ` ${Object.values(gamedata.teams)[s[id]].title}`;
                                        tempRes = tempRes.replace('SRC', s[id]);
//                                        console.log()
                                        if (Object.values(gamedata.teams)[s[id]].title === t.title) {
                                            outStr += `itself (${s[id]})`;
                                        } else {
                                            outStr += `${Object.values(gamedata.teams)[s[id]].title} (${s[id]})`;
                                        }
                                    } else {
//                                        str += ` ${s[id]}`;
                                        outStr += `: ${s[id]}`;
                                    }
                                }
                            });
                            tempRes = tempRes.replace('BLANK', '');
//                            console.log(outStr);
//                            console.log(`st{{id}}_v1`);
//                            console.log(`from : ${temp} to: ${tempRes}`);
                            outo.dest = tempRes;
                            console.log(outo);
                            if ($(`#${outo.dest}`).length > 0) {
                                $(`#${outo.dest}`).html(outo.val);
                            }
                            s[2] = parseInt(s[2]) + 1;
//                            let out = temp.replace('TYPE', ref[scoreMap[1]][s[1]])
                            let out = temp;
                            out = out.replace('DEST', t.id);
                            let team = parseInt(s[2]) - (parseInt(s[1]) === 2 ? type2Adj : 0);
                            out = out.replace('SRC', team);
                            out = out.replace('BLANK', '');
//                                console.log(s);
                            // NOTE: Team IDs are 1 - 6, so PV IDs are 5 and 6
//                                console.log(` - ${out}`);
//                                console.log(s);
                            s.forEach((v, id) => {
                                if (Boolean(scoreMap[id])) {

                                    str = ` - ${scoreMap[id]}: ${v}`;
                                    if (ref.hasOwnProperty(scoreMap[id])) {
                                        str += ` (${ref[scoreMap[id]][v]})`;
//                                            d = `${ref[scoreMap[id]][v]}${t.id}_v${v}`;
                                    }
//                                        console.log(str);
//                                        str = `st{{id}}_v1`;
//                                        console.log(str);
                                }
                            })
                        });
                    }

                    if ($(`#stakeholder_card_${t.id}`).length) {

                    }
                });
            })
                $('.stakeholder_card').each((c) => {
//                    console.log(c);
                });
        };
        const updateSlide = (t) => {
            updateCards();
            if ($('.stakeholder_card').length > 0) {
                // update the cards

            }
        };
        // Methods that could potentially be made universal
        const renderTemplate = (temp, targ, o) => {
            targ = '#' + targ;
            let ob = Object.assign({}, o);
            const compiledTemplate = Handlebars.templates[temp];
            const renderedHtml = compiledTemplate(ob);
            $(targ).html('');
            $(targ).html(renderedHtml);
        };
        const clearContent = () => {
            $('#content').html('');
        };
        const slideSpecificSetup = () => {
            if ($('.stakeholder_card').length > 0) {
                setupCards();
            }
            if ($('.intro').length > 0) {
                setupIntro();
            }
        };
        const renderSlide = (temp, o) => {
            let targ = `content`;
            renderTemplate(temp, targ, o);
            slideSpecificSetup();
            if (o.hasOwnProperty('action')) {
                //
            }
        };
        const presentationUpdate = (p) => {
            presentationData = p;
//            console.log('hup');
//            console.log(p);
//            console.log(presentationData);
            refreshSlide();
        };
        const init = () => {
            socket.emit('getScoreMap', (m) => {
                scoreMap = m;
            });
            let i = getInfo();
            let cs = 0;
            if (i) {
                cs = i.currentSlide ? i.currentSlide : 0;
            }
            showSlide(cs);
        };
        const reset = () => {
            showSlide(0);
        };
        socket.on('disconnect', () => {
//            console.log('gone')
            reset();
        });
        socket.on('connect', () => {
            console.log(`presentation connect`);
            socket.emit('customDataEvent', clientData);
            socket.emit('getPresentationPack', (p) => {
                presentationData = p;
                gamedata = p.gamedata;
                STOREID = gamedata.constants.presentation;
//                console.log(gamedata);
                slideList = p.slideList;
                init();
            });
//            socket.emit('getGameData', (gd) => {
//                console.log('getGameData')
//                console.log(gd);
//            })
//
//            socket.emit('getSession', (gd) => {
//                console.log('getSession')
//                console.log(gd);
//            })

        });
        socket.on('nextSlide', nextSlide);
        socket.on('previousSlide', previousSlide);
        socket.on('reloadSlide', refreshSlide);
        socket.on('gotoSlide', (s) => {
            showSlide(s);
        });
        socket.on('updatePresentationPack', (p) => {presentationUpdate(p)});
        socket.on('updateAllocation1', (o) => {
            // replaced by the sessionUpdate event
            return;
            console.log(`updateAllocation`);
            console.log(o);
            updateCard1(o.t, 'action_name', o.action_name);
            updateCard1(o.t, 'action_desc', o.action_desc);
            updateCard1(o.t, 'resource', o.resource);
        });
        socket.on('sessionUpdate', (s) => {
            onSessionUpdate(s);
//            updateSlide();

        })

    </script>
</body>

</html>
